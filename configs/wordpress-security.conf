# WordPress Security Configuration for OpenLiteSpeed + CyberPanel
# File: wordpress-security.conf
# Apache-compatible rules for OpenLiteSpeed webserver
# Place this in VirtualHost context or include from .htaccess

# ============================================================
# BLOCK SENSITIVE FILES (Highest Priority)
# ============================================================

# Exact file blocking
<Files "wp-config.php">
    Require all denied
</Files>

<Files "wp-config-sample.php">
    Require all denied
</Files>

<Files "xmlrpc.php">
    Require all denied
</Files>

<Files "readme.html">
    Require all denied
</Files>

<Files "license.txt">
    Require all denied
</Files>

<Files "wp-admin/install.php">
    Require all denied
</Files>

<Files "wp-admin/upgrade.php">
    Require all denied
</Files>

<Files "wp-content/debug.log">
    Require all denied
</Files>

# ============================================================
# BLOCK PHP EXECUTION IN UPLOADS
# ============================================================

<DirectoryMatch "^/home/[^/]+/[^/]+/public_html/wp-content/uploads/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Alternative method using RewriteRule
<Directory "/wp-content/uploads">
    RewriteEngine On
    RewriteRule \.php$ - [F,L]
</Directory>

# ============================================================
# BLOCK PHP EXECUTION IN WP-INCLUDES (except multisite)
# ============================================================

<DirectoryMatch "^/home/[^/]+/[^/]+/public_html/wp-includes/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Multisite exception - allow ms-files.php
<Files "ms-files.php">
    Require all granted
</Files>

# ============================================================
# BLOCK BACKUP AND COMPRESSED FILES
# ============================================================

<FilesMatch "\.(bak|backup|old|orig|original|php~|php\.save|php\.bak|php#)$">
    Require all denied
</FilesMatch>

<FilesMatch "\.(log|sql|swp|swo)$">
    Require all denied
</FilesMatch>

<FilesMatch "^/wp-content/.*\.(zip|gz|tar|bzip2|7z|rar)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK DEVELOPMENT AND DOCUMENTATION FILES
# ============================================================

<FilesMatch "^/wp-content/plugins/.+\.(txt|log|md)$">
    Require all denied
</FilesMatch>

<FilesMatch "^/wp-content/themes/.+\.(txt|log|md)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK HIDDEN FILES
# ============================================================

<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.user\.ini$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK DANGEROUS SCRIPT TYPES
# ============================================================

<FilesMatch "\.(pl|cgi|py|sh|lua|asp|aspx|exe|dll)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK KNOWN EXPLOIT FILES
# ============================================================

<FilesMatch "(timthumb|thumb|thumbnail|phpinfo|webshell|shell|c99|r57|backdoor|evil|hack|mobiquo)\.php$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK ATTACK PATTERNS (Query String Filtering)
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block eval() in query strings
    RewriteCond %{QUERY_STRING} ^(.*)(eval\()(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # Block base64_encode in query strings
    RewriteCond %{QUERY_STRING} ^(.*)(base64_encode)(.*)(\()(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # Block GLOBALS and REQUEST attacks
    RewriteCond %{QUERY_STRING} ^(.*)(GLOBALS|REQUEST)(=|\[|%).*$
    RewriteRule ^(.*)$ - [F,L]

    # Block script tag patterns
    RewriteCond %{QUERY_STRING} ^(.*)(<|%3C).*script.*(>|%3).*$
    RewriteRule ^(.*)$ - [F,L]

    # Block SQL injection patterns
    RewriteCond %{QUERY_STRING} ^(.*)(drop|insert|md5|select|union).*$
    RewriteRule ^(.*)$ - [F,L]

    # Block file path attacks
    RewriteCond %{QUERY_STRING} ^(.*)(boot\.ini|etc/passwd|self/environ).*$
    RewriteRule ^(.*)$ - [F,L]

    # Block localhost references
    RewriteCond %{QUERY_STRING} ^(.*)(127\.0\.0\.1).*$
    RewriteRule ^(.*)$ - [F,L]

    # Block very long query strings (possible DoS)
    RewriteCond %{QUERY_STRING} ^(.{2000,})$
    RewriteRule ^(.*)$ - [F,L]

    # Block JavaScript patterns
    RewriteCond %{QUERY_STRING} ^(.*)(javascript\:)(.*)(\;).*$
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ============================================================
# BLOCK MALICIOUS USER AGENTS
# ============================================================

<IfModule mod_setenvif.c>
    SetEnvIfNoCase User-Agent "^(sqlmap|nikto|nmap|w3af|acunetix|burp|openvas|skipfish)" bad_bot
    SetEnvIfNoCase User-Agent "^(curl|python-urllib|java|wget|libwww-perl|winhttp)" bad_bot
    SetEnvIfNoCase User-Agent "^(bytespider|mj12bot|ahrefs|semrush|screaming frog)" bad_bot
    SetEnvIfNoCase User-Agent "^(baiduspider|yandex|sogou|360spider|soso)" bad_bot

    <RequireAll>
        Require all granted
        Require not env bad_bot
    </RequireAll>
</IfModule>

# ============================================================
# BLOCK DISALLOWED HTTP METHODS
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|CONNECT|DEBUG|MOVE)$
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ============================================================
# SECURITY HEADERS
# ============================================================

<IfModule mod_headers.c>
    # Prevent MIME-type sniffing
    Header always set X-Content-Type-Options nosniff

    # Prevent clickjacking
    Header always set X-Frame-Options SAMEORIGIN

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Hide server details
    Header always set Server "OpenLiteSpeed"
</IfModule>

# ============================================================
# LIMIT REQUEST SIZE
# ============================================================

<IfModule mod_reqtimeout.c>
    # Limit request body size (10MB max)
    LimitRequestBody 10485760

    # Limit request line size
    LimitRequestLine 8190

    # Limit request field size
    LimitRequestFieldSize 8190
</IfModule>

# ============================================================
# ERROR PAGES
# ============================================================

# Custom error pages for security responses
ErrorDocument 403 "Access Denied"
ErrorDocument 405 "Method Not Allowed"

# ============================================================
# END OF WORDPRESS SECURITY CONFIGURATION
# ============================================================