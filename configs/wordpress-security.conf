# WordPress Security Configuration for OpenLiteSpeed + CyberPanel
# File: wordpress-security.conf
# Apache-compatible rules for OpenLiteSpeed webserver
# Place this in VirtualHost context or include from .htaccess

# ============================================================
# BLOCK SENSITIVE FILES (Highest Priority)
# ============================================================

# Exact file blocking
<Files "wp-config.php">
    Require all denied
</Files>

<Files "wp-config-sample.php">
    Require all denied
</Files>

<Files "xmlrpc.php">
    Require all denied
</Files>

<Files "readme.html">
    Require all denied
</Files>

<Files "license.txt">
    Require all denied
</Files>

<Files "wp-admin/install.php">
    Require all denied
</Files>

<Files "wp-admin/upgrade.php">
    Require all denied
</Files>

<Files "wp-content/debug.log">
    Require all denied
</Files>

# ============================================================
# BLOCK PHP EXECUTION IN UPLOADS
# ============================================================

# Method 1: Using RewriteRules (CyberPanel compatible)
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block PHP in uploads directory (works in any location)
    RewriteRule ^wp-content/uploads/.*\.php$ - [F,L,NC]
    RewriteRule ^.*/wp-content/uploads/.*\.php$ - [F,L,NC]
</IfModule>

# Method 2: DirectoryMatch (fallback for direct paths)
<DirectoryMatch "^.*/wp-content/uploads/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# ============================================================
# BLOCK PHP EXECUTION IN WP-INCLUDES (except multisite)
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block PHP in wp-includes (except allowed files)
    RewriteRule ^wp-includes/.*\.php$ - [F,L,NC]
    RewriteRule ^.*/wp-includes/.*\.php$ - [F,L,NC]

    # Allow multisite files
    RewriteRule ^wp-includes/ms-files\.php$ - [L,NC]
    RewriteRule ^.*/wp-includes/ms-files\.php$ - [L,NC]
</IfModule>

<DirectoryMatch "^.*/wp-includes/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Allow multisite ms-files.php
<Files "ms-files.php">
    Require all granted
</Files>

# ============================================================
# BLOCK BACKUP AND COMPRESSED FILES
# ============================================================

<FilesMatch "\.(bak|backup|old|orig|original|php~|php\.save|php\.bak|php#)$">
    Require all denied
</FilesMatch>

<FilesMatch "\.(log|sql|swp|swo)$">
    Require all denied
</FilesMatch>

<FilesMatch "^/wp-content/.*\.(zip|gz|tar|bzip2|7z|rar)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK DEVELOPMENT AND DOCUMENTATION FILES
# ============================================================

<FilesMatch "^/wp-content/plugins/.+\.(txt|log|md)$">
    Require all denied
</FilesMatch>

<FilesMatch "^/wp-content/themes/.+\.(txt|log|md)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK HIDDEN FILES
# ============================================================

<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.user\.ini$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK DANGEROUS SCRIPT TYPES
# ============================================================

<FilesMatch "\.(pl|cgi|py|sh|lua|asp|aspx|exe|dll)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK KNOWN EXPLOIT FILES
# ============================================================

<FilesMatch "(timthumb|thumb|thumbnail|phpinfo|webshell|shell|c99|r57|backdoor|evil|hack|mobiquo)\.php$">
    Require all denied
</FilesMatch>

# ============================================================
# OPTIMIZED ATTACK PATTERN FILTERING (OpenLiteSpeed-Friendly)
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # HIGH-PRIORITY DANGEROUS PATTERNS (block immediately)
    RewriteCond %{QUERY_STRING} (union.*select|insert.*into|delete.*from|drop.*table) [NC,OR]
    RewriteCond %{QUERY_STRING} (javascript:|<script|</script|eval\(|expression\() [NC,OR]
    RewriteCond %{QUERY_STRING} (\.\./|\.\.\\|/etc/passwd|/proc/self/environ) [NC,OR]
    RewriteCond %{QUERY_STRING} (GLOBALS\[|_REQUEST\[|_POST\[|_GET\[) [NC,OR]
    RewriteCond %{QUERY_STRING} (webshell|c99|r57|backdoor|evil\.php) [NC]
    RewriteRule ^(.*)$ - [F,L]

    # MEDIUM-PRIORITY PATTERNS (less aggressive to avoid false positives)
    RewriteCond %{QUERY_STRING} (select.*from|insert.*values|update.*set) [NC,OR]
    RewriteCond %{QUERY_STRING} (document\.cookie|window\.location|alert\(|confirm\() [NC,OR]
    RewriteCond %{QUERY_STRING} (php://|file://|include.*file|require.*file) [NC,OR]
    RewriteCond %{QUERY_STRING} (wp-config\.php|wp-settings\.php|\.htaccess) [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.{300,})$  # Long query strings (possible DoS)
    RewriteRule ^(.*)$ - [F,L]

    # LOW-PRIORITY PATTERNS (only if no match above)
    RewriteCond %{QUERY_STRING} (;|\||&|`|\$\() [NC,OR]
    RewriteCond %{QUERY_STRING} (base64_decode|from_base64) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ============================================================
# SEO-SAFE BOT PROTECTION (OPENLITESPEED-COMPATIBLE)
# ============================================================

<IfModule mod_setenvif.c>
    # Block only dangerous security scanners (SEO-safe)
    SetEnvIfNoCase User-Agent "^(sqlmap|nikto|nmap|w3af|acunetix|burp|openvas|skipfish)" bad_bot
    SetEnvIfNoCase User-Agent "^(nuclei|masscan|zap|arachni|netsparker|appscan)" bad_bot

    # Block obvious malicious tools
    SetEnvIfNoCase User-Agent "^(havij|pangolin|netsparker|acunetix|paros)" bad_bot

    # Block automated scanners (but NOT legitimate crawlers)
    SetEnvIfNoCase User-Agent "^(python-urllib|python-requests|scrapy|beautifulsoup)" bad_bot
    SetEnvIfNoCase User-Agent "^(java|perl|curl|wget|libwww-perl|winhttp|lwp)" bad_bot

    # SEO-SAFE: Allow all search engines and legitimate crawlers
    # Do NOT block general "bot", "crawl", or "spider" patterns
    # This prevents accidentally blocking legitimate crawlers
</IfModule>

# Use OpenLiteSpeed compatible access control
<IfModule mod_authz_core.c>
    <RequireAll>
        Require all granted
        Require not env bad_bot
    </RequireAll>
</IfModule>

# Fallback for older Apache versions
<IfModule !mod_authz_core.c>
    Order allow,deny
    Allow from all
    Deny from env=bad_bot
</IfModule>

# ============================================================
# BLOCK DISALLOWED HTTP METHODS
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|CONNECT|DEBUG|MOVE)$
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ============================================================
# SECURITY HEADERS
# ============================================================

<IfModule mod_headers.c>
    # Prevent MIME-type sniffing
    Header always set X-Content-Type-Options nosniff

    # Prevent clickjacking
    Header always set X-Frame-Options SAMEORIGIN

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Hide server details
    Header always set Server "OpenLiteSpeed"
</IfModule>

# ============================================================
# SMART BOT VERIFICATION (OPENLITESPEED-OPTIMIZED)
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # === GOOGLEBOT VERIFICATION (SIMPLIFIED) ===
    # Only verify if user agent claims to be Googlebot
    RewriteCond %{HTTP_USER_AGENT} ^googlebot [NC]
    RewriteCond %{REMOTE_ADDR} !^66\.249\. [OR]
    RewriteCond %{REMOTE_ADDR} !^216\.239\. [OR]
    RewriteCond %{REMOTE_ADDR} !^64\.233\.
    RewriteRule ^ - [F,L]

    # === BINGBOT VERIFICATION (SIMPLIFIED) ===
    # Only verify if user agent claims to be Bingbot
    RewriteCond %{HTTP_USER_AGENT} ^bingbot [NC]
    RewriteCond %{REMOTE_ADDR} !^157\.55\. [OR]
    RewriteCond %{REMOTE_ADDR} !^40\.77\. [OR]
    RewriteCond %{REMOTE_ADDR} !^207\.46\.
    RewriteRule ^ - [F,L]

    # Note: For dynamic IP updates, use CyberPanel cron to update this file
    # Dynamic bot verification is handled separately via update scripts
</IfModule>

# ============================================================
# SEO-FRIENDLY RATE LIMITING
# ============================================================

<IfModule mod_reqtimeout.c>
    # Limit request body size (10MB max - SEO-friendly for uploads)
    LimitRequestBody 10485760

    # Limit request line size
    LimitRequestLine 8190

    # Limit request field size
    LimitRequestFieldSize 8190

    # Timeout settings (prevent slow attacks)
    RequestReadTimeout header=20-40,MinRate=500 body=10,MinRate=500
</IfModule>

# ============================================================
# IP-BASED PROTECTION
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Whitelist common good IPs (search engines, CDNs)
    RewriteCond %{REMOTE_ADDR} ^66\.249\. [OR]
    RewriteCond %{REMOTE_ADDR} ^216\.239\. [OR]
    RewriteCond %{REMOTE_ADDR} ^64\.233\. [OR]
    RewriteCond %{REMOTE_ADDR} ^72\.14\. [OR]
    RewriteCond %{REMOTE_ADDR} ^157\.55\. [OR]  # Bing
    RewriteCond %{REMOTE_ADDR} ^40\.77\. [OR]    # Bing
    RewriteCond %{REMOTE_ADDR} ^207\.46\. [OR]  # Bing
    RewriteCond %{REMOTE_ADDR} ^131\.253\. [OR] # Bing
    RewriteCond %{REMOTE_ADDR} ^199\.30\. [OR]  # DuckDuckGo
    RewriteCond %{REMOTE_ADDR} ^52\.2\.230\.
    RewriteRule ^ - [S=2]  # Skip rate limits for good IPs

    # Rate limiting for suspicious IPs (not SEO bots)
    RewriteCond %{REMOTE_ADDR} ^(.*)$
    RewriteRule ^ - [E=rate_limit:%1]

    # Block IPs making too many requests to wp-login.php
    RewriteCond %{REQUEST_URI} ^/wp-login\.php$
    RewriteCond %{REMOTE_ADDR} ^(.*)$
    # Note: In production, use fail2ban or similar for proper rate limiting
</IfModule>

# ============================================================
# ERROR PAGES
# ============================================================

# Custom error pages for security responses
ErrorDocument 403 "Access Denied"
ErrorDocument 405 "Method Not Allowed"

# ============================================================
# END OF WORDPRESS SECURITY CONFIGURATION
# ============================================================