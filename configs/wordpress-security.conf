# WordPress Security Configuration for OpenLiteSpeed + CyberPanel
# File: wordpress-security.conf
# Apache-compatible rules for OpenLiteSpeed webserver
# Place this in VirtualHost context or include from .htaccess

# ============================================================
# BLOCK SENSITIVE FILES (Highest Priority)
# ============================================================

# Exact file blocking
<Files "wp-config.php">
    Require all denied
</Files>

<Files "wp-config-sample.php">
    Require all denied
</Files>

<Files "xmlrpc.php">
    Require all denied
</Files>

<Files "readme.html">
    Require all denied
</Files>

<Files "license.txt">
    Require all denied
</Files>

<Files "wp-admin/install.php">
    Require all denied
</Files>

<Files "wp-admin/upgrade.php">
    Require all denied
</Files>

<Files "wp-content/debug.log">
    Require all denied
</Files>

# ============================================================
# BLOCK PHP EXECUTION IN UPLOADS
# ============================================================

<DirectoryMatch "^/home/[^/]+/[^/]+/public_html/wp-content/uploads/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Alternative method using RewriteRule
<Directory "/wp-content/uploads">
    RewriteEngine On
    RewriteRule \.php$ - [F,L]
</Directory>

# ============================================================
# BLOCK PHP EXECUTION IN WP-INCLUDES (except multisite)
# ============================================================

<DirectoryMatch "^/home/[^/]+/[^/]+/public_html/wp-includes/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Multisite exception - allow ms-files.php
<Files "ms-files.php">
    Require all granted
</Files>

# ============================================================
# BLOCK BACKUP AND COMPRESSED FILES
# ============================================================

<FilesMatch "\.(bak|backup|old|orig|original|php~|php\.save|php\.bak|php#)$">
    Require all denied
</FilesMatch>

<FilesMatch "\.(log|sql|swp|swo)$">
    Require all denied
</FilesMatch>

<FilesMatch "^/wp-content/.*\.(zip|gz|tar|bzip2|7z|rar)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK DEVELOPMENT AND DOCUMENTATION FILES
# ============================================================

<FilesMatch "^/wp-content/plugins/.+\.(txt|log|md)$">
    Require all denied
</FilesMatch>

<FilesMatch "^/wp-content/themes/.+\.(txt|log|md)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK HIDDEN FILES
# ============================================================

<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.user\.ini$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK DANGEROUS SCRIPT TYPES
# ============================================================

<FilesMatch "\.(pl|cgi|py|sh|lua|asp|aspx|exe|dll)$">
    Require all denied
</FilesMatch>

# ============================================================
# BLOCK KNOWN EXPLOIT FILES
# ============================================================

<FilesMatch "(timthumb|thumb|thumbnail|phpinfo|webshell|shell|c99|r57|backdoor|evil|hack|mobiquo)\.php$">
    Require all denied
</FilesMatch>

# ============================================================
# ADVANCED ATTACK PATTERN FILTERING (Nginx-Inspired)
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # === SQL Injection Protection ===
    RewriteCond %{QUERY_STRING} ^(.*)(\b(union|select|insert|update|delete|drop|create|alter|exec|execute)\b)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(information_schema|sysobjects|syscolumns)\b)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(and|or)\b\s+\d+\s*=\s*\d+)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(and|or)\b\s+['"]?\w+['"]?\s*=\s*['"]?\w+['"]?)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(['"]\s*(and|or)\s+['"]?\w+['"]?\s*=\s*['"]?\w+['"]?)(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # === XSS Protection ===
    RewriteCond %{QUERY_STRING} ^(.*)(<|%3C)(script|iframe|object|embed|form|input|textarea)(.*)(>|%3E)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(javascript:|vbscript:|onload=|onerror=|onclick=)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(alert|confirm|prompt|eval\(|expression\()(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(document\.cookie|document\.location|window\.location)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(char|from_base64|base64_decode)\b)(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # === Path Traversal & File Inclusion ===
    RewriteCond %{QUERY_STRING} ^(.*)(\.\./|\.\.\\)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(/etc/passwd|/etc/shadow|/proc/self/environ)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(boot\.ini|win\.ini|system32)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(php://|file://|ftp://|data://)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(include|require|include_once|require_once)\b)(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # === Command Injection ===
    RewriteCond %{QUERY_STRING} ^(.*)(;|\||&|`|\$\(|\$\{)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(nc|netcat|wget|curl|perl|python|bash|sh)\b)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(rm|mv|cp|cat|ls|ps|kill|chmod|chown)\b)(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # === WordPress Specific Attacks ===
    RewriteCond %{QUERY_STRING} ^(.*)(GLOBALS\[|_REQUEST\[|_POST\[|_GET\[)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(wp-config\.php|wp-settings\.php|\.htaccess)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(timthumb\.php|thumb\.php|phpinfo\.php)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(webshell|c99|r57|backdoor|evil|hack)(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # === DoS & Flood Protection ===
    RewriteCond %{QUERY_STRING} ^(.{500,})$ [OR]
    RewriteCond %{QUERY_STRING} ^(.*)(127\.0\.0\.1|localhost|0x7f000001)(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\b(sleep|benchmark|pg_sleep\()\b)(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]

    # === Suspicious Encoding ===
    RewriteCond %{QUERY_STRING} ^(.*)(%[0-9a-f]{2}){5,}(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\.\.\/){3,}(.*?)$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^(.*)(\@|\$|\%|\^|\&|\*|\(|\)|\[|\]|\{|\})(.*?)$ [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ============================================================
# SEO-SAFE BOT PROTECTION
# ============================================================

<IfModule mod_setenvif.c>
    # Allow legitimate search engine crawlers (SEO-safe)
    SetEnvIfNoCase User-Agent "^googlebot" good_bot
    SetEnvIfNoCase User-Agent "^googlebot-image" good_bot
    SetEnvIfNoCase User-Agent "^googlebot-news" good_bot
    SetEnvIfNoCase User-Agent "^bingbot" good_bot
    SetEnvIfNoCase User-Agent "^slurp" good_bot
    SetEnvIfNoCase User-Agent "^duckduckbot" good_bot
    SetEnvIfNoCase User-Agent "^baiduspider" good_bot
    SetEnvIfNoCase User-Agent "^yandex" good_bot
    SetEnvIfNoCase User-Agent "^facebookexternalhit" good_bot
    SetEnvIfNoCase User-Agent "^twitterbot" good_bot
    SetEnvIfNoCase User-Agent "^linkedinbot" good_bot
    SetEnvIfNoCase User-Agent "^whatsapp" good_bot
    SetEnvIfNoCase User-Agent "^telegrambot" good_bot
    SetEnvIfNoCase User-Agent "^applebot" good_bot
    SetEnvIfNoCase User-Agent "^ia_archiver" good_bot

    # Block security scanners and malicious bots
    SetEnvIfNoCase User-Agent "^(sqlmap|nikto|nmap|w3af|acunetix|burp|openvas|skipfish)" bad_bot
    SetEnvIfNoCase User-Agent "^(nuclei|masscan|zap|arachni|netsparker|appscan)" bad_bot
    SetEnvIfNoCase User-Agent "^(python-urllib|python-requests|scrapy|beautifulsoup)" bad_bot
    SetEnvIfNoCase User-Agent "^(java|perl|curl|wget|libwww-perl|winhttp|lwp)" bad_bot

    # Block known spam/scrapers (but keep SEO-friendly bots)
    SetEnvIfNoCase User-Agent "^(80legs|masscan|zgrab|nmap|megaindex)" bad_bot
    SetEnvIfNoCase User-Agent "^(semrush|ahrefsbot|majestic-12|mj12bot)" bad_bot
    SetEnvIfNoCase User-Agent "^(screaming frog|screamingfrog)" bad_bot
    SetEnvIfNoCase User-Agent "^(dotbot|linkdex|blexbot|backlinkcrawler)" bad_bot

    # Block suspicious patterns
    SetEnvIfNoCase User-Agent "bot" suspicious_bot
    SetEnvIfNoCase User-Agent "crawl" suspicious_bot
    SetEnvIfNoCase User-Agent "spider" suspicious_bot

    # Good bots override suspicious patterns
    SetEnvIfNoCase User-Agent "^(google|bing|yahoo|duckduck|baidu|yandex)" !suspicious_bot

    <RequireAll>
        Require all granted
        Require not env bad_bot
        Require not env suspicious_bot
    </RequireAll>
</IfModule>

# ============================================================
# BLOCK DISALLOWED HTTP METHODS
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|CONNECT|DEBUG|MOVE)$
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ============================================================
# SECURITY HEADERS
# ============================================================

<IfModule mod_headers.c>
    # Prevent MIME-type sniffing
    Header always set X-Content-Type-Options nosniff

    # Prevent clickjacking
    Header always set X-Frame-Options SAMEORIGIN

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Hide server details
    Header always set Server "OpenLiteSpeed"
</IfModule>

# ============================================================
# GOOGLEBOT VERIFICATION (SEO-CRITICAL)
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Verify Googlebot requests against official Google IP ranges
    # Allow requests without Googlebot user agent
    RewriteCond %{HTTP_USER_AGENT} !^googlebot [NC]
    RewriteRule ^ - [S=3]

    # If user agent is Googlebot, verify IP ranges
    # Googlebot IP ranges (simplified version - should be updated regularly)
    RewriteCond %{REMOTE_ADDR} ^66\.249\.(6[4-9]|7[0-9]|8[0-9]|9[0-5])\. [OR]
    RewriteCond %{REMOTE_ADDR} ^216\.239\.(3[2-9]|4[0-9]|5[0-9]|6[0-3])\. [OR]
    RewriteCond %{REMOTE_ADDR} ^64\.233\.(1[6-9][0-9]|2[0-9]{2}|30[0-9]|31[0-9])\. [OR]
    RewriteCond %{REMOTE_ADDR} ^72\.14\.(19[2-9]|2[0-9]{2}|22[0-3])\.
    RewriteRule ^ - [S=1]

    # Block fake Googlebot (wrong IP range)
    RewriteCond %{HTTP_USER_AGENT} ^googlebot [NC]
    RewriteRule ^ - [F,L]
</IfModule>

# ============================================================
# SEO-FRIENDLY RATE LIMITING
# ============================================================

<IfModule mod_reqtimeout.c>
    # Limit request body size (10MB max - SEO-friendly for uploads)
    LimitRequestBody 10485760

    # Limit request line size
    LimitRequestLine 8190

    # Limit request field size
    LimitRequestFieldSize 8190

    # Timeout settings (prevent slow attacks)
    RequestReadTimeout header=20-40,MinRate=500 body=10,MinRate=500
</IfModule>

# ============================================================
# IP-BASED PROTECTION
# ============================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Whitelist common good IPs (search engines, CDNs)
    RewriteCond %{REMOTE_ADDR} ^66\.249\. [OR]
    RewriteCond %{REMOTE_ADDR} ^216\.239\. [OR]
    RewriteCond %{REMOTE_ADDR} ^64\.233\. [OR]
    RewriteCond %{REMOTE_ADDR} ^72\.14\. [OR]
    RewriteCond %{REMOTE_ADDR} ^157\.55\. [OR]  # Bing
    RewriteCond %{REMOTE_ADDR} ^40\.77\. [OR]    # Bing
    RewriteCond %{REMOTE_ADDR} ^207\.46\. [OR]  # Bing
    RewriteCond %{REMOTE_ADDR} ^131\.253\. [OR] # Bing
    RewriteCond %{REMOTE_ADDR} ^199\.30\. [OR]  # DuckDuckGo
    RewriteCond %{REMOTE_ADDR} ^52\.2\.230\.
    RewriteRule ^ - [S=2]  # Skip rate limits for good IPs

    # Rate limiting for suspicious IPs (not SEO bots)
    RewriteCond %{REMOTE_ADDR} ^(.*)$
    RewriteRule ^ - [E=rate_limit:%1]

    # Block IPs making too many requests to wp-login.php
    RewriteCond %{REQUEST_URI} ^/wp-login\.php$
    RewriteCond %{REMOTE_ADDR} ^(.*)$
    # Note: In production, use fail2ban or similar for proper rate limiting
</IfModule>

# ============================================================
# ERROR PAGES
# ============================================================

# Custom error pages for security responses
ErrorDocument 403 "Access Denied"
ErrorDocument 405 "Method Not Allowed"

# ============================================================
# END OF WORDPRESS SECURITY CONFIGURATION
# ============================================================